<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Player Projections Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cavs-wine: #6F263D;
            --cavs-gold: #FDBB30;
            --cavs-navy: #041E42;
            --cavs-light-gray: #E0E0E0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; /* Lighter gray */
        }
        .table-header-sortable {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
        }
        .table-header-sortable:hover {
            background-color: var(--cavs-light-gray);
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            max-width: 90vw;
            width: 700px;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .percentile-cell {
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.8rem;
            line-height: 1.1rem;
            min-width: 70px;
        }
        .percentile-value {
            font-weight: 600;
        }
        .percentile-rank {
            font-size: 0.7rem;
            line-height: 1rem;
            opacity: 0.9;
        }
        .toggle-button svg {
            transition: transform 0.3s ease;
        }
        .section-collapsed .toggle-button svg {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl md:text-6xl font-bold" style="color: var(--cavs-wine);">NBA Player Projections</h1>
            <p class="text-lg text-gray-700 mt-2">Interactive data for the upcoming season</p>
        </header>

        <!-- Main Content -->
        <main>
             <!-- Quick Jump Links -->
            <div class="flex justify-center gap-4 mb-8">
                <a href="#metrics-section" class="bg-white text-gray-800 font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-100 transition">Jump to Metrics</a>
                <a href="#projections-section" class="bg-white text-gray-800 font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-100 transition">Jump to Projections</a>
            </div>

            <!-- Data Visualization Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-center" style="color: var(--cavs-navy);">Projected Y1 Team Strength</h2>
                    <div class="relative h-96 w-full">
                        <canvas id="teamChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-center" style="color: var(--cavs-navy);">5-Year Team Outlook</h2>
                    <div class="relative h-96 w-full">
                        <canvas id="teamChart5Year"></canvas>
                    </div>
                </div>
            </div>

            <!-- Search Filter -->
            <div class="mb-8 bg-white p-6 rounded-2xl shadow-lg">
                 <input type="text" id="searchInput" placeholder="Search by player or team..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--cavs-gold)] transition">
            </div>

            <!-- Player Metrics Table -->
            <div id="metrics-section" class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" data-toggle="metrics-content">
                    <h2 class="text-2xl font-bold">Player Metrics Breakdown</h2>
                    <button class="toggle-button p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="metrics-content" class="collapsible-content overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-xs">
                        <thead id="metricsTableHead" class="bg-gray-100">
                             <tr>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Player">Player</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Team">Team</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Age">Age</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Pos">Pos</th>
                                <!-- Overall -->
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="epm">Ovr-EPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Ovr-xRAPM">Ovr-xRAPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Ovr-LEBRON">Ovr-LEBRON</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Ovr-DARKO">Ovr-DARKO</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable bg-gray-200" data-sort="Multi-Year Ovr">Ovr Comp.</th>
                                <!-- Offensive -->
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Multi-Year OEPM">Off-EPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="xORAPM">Off-xRAPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="oLEBRON">Off-LEBRON</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="oDARKO">Off-DARKO</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="CombinedOff">Off Comp.</th>
                                <!-- Defensive -->
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Multi-Year DEPM">Def-EPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="xDRAPM">Def-xRAPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="dLEBRON">Def-LEBRON</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="dDARKO">Def-DARKO</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="CombinedDef">Def Comp.</th>
                            </tr>
                        </thead>
                        <tbody id="metricsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Player Projections Table -->
            <div id="projections-section" class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4 cursor-pointer" data-toggle="projections-content">
                    <h2 class="text-2xl font-bold">Long-Term Projections</h2>
                    <button class="toggle-button p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="projections-content" class="collapsible-content overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-xs">
                        <thead id="projectionsTableHead" class="bg-gray-100">
                            <tr>
                               <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Player">Player</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Team">Team</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Age">Age</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Pos">Pos</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y1EPM">Y1 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y1PV">Y1 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y2EPM">Y2 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y2PV">Y2 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y3EPM">Y3 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y3PV">Y3 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y4EPM">Y4 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y4PV">Y4 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y5EPM">Y5 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y5PV">Y5 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable bg-gray-200" data-sort="Three-Year PV Avg">3-Yr PV Avg</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable bg-gray-200" data-sort="Five-Year PV Avg">5-Yr PV Avg</th>
                            </tr>
                        </thead>
                        <tbody id="projectionsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Player Details Modal -->
    <div id="playerModal" class="modal-backdrop hidden">
        <div class="bg-white rounded-2xl shadow-2xl modal-content overflow-hidden transform transition-all duration-300 scale-95 opacity-0">
             <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 id="modalPlayerName" class="text-2xl font-bold"></h3>
                    <p id="modalPlayerInfo" class="text-gray-600"></p>
                </div>
                <button id="closeModal" class="text-gray-400 hover:text-gray-800 transition text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 max-h-[80vh] overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-lg mb-2">Key Metrics</h4>
                        <canvas id="playerMetricsChart"></canvas>
                    </div>
                    <div id="modalStats" class="space-y-2 text-sm"></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CSV_PATH = 'Composite Projections.csv';
            
            // --- DOM Elements ---
            const searchInput = document.getElementById('searchInput');
            const teamChartCanvas = document.getElementById('teamChart');
            const teamChart5YearCanvas = document.getElementById('teamChart5Year');
            const metricsTableBody = document.getElementById('metricsTableBody');
            const projectionsTableBody = document.getElementById('projectionsTableBody');
            const metricsTableHead = document.getElementById('metricsTableHead');
            const projectionsTableHead = document.getElementById('projectionsTableHead');

            // --- Modal Elements ---
            const playerModal = document.getElementById('playerModal');
            const modalPlayerName = document.getElementById('modalPlayerName');
            const modalPlayerInfo = document.getElementById('modalPlayerInfo');
            const modalStats = document.getElementById('modalStats');
            const closeModal = document.getElementById('closeModal');
            const playerMetricsChartCanvas = document.getElementById('playerMetricsChart');
            
            // --- State ---
            let allPlayers = [];
            let metricsSortState = { column: 'Multi-Year Ovr', direction: 'desc' };
            let projectionsSortState = { column: 'Y1EPM', direction: 'desc' };
            let teamChartInstance = null;
            let teamChart5YearInstance = null;
            let playerChartInstance = null;

             const METRICS_FOR_PERCENTILES = [
                'Multi-Year OEPM', 'xORAPM', 'oLEBRON', 'oDARKO', 'CombinedOff',
                'Multi-Year DEPM', 'xDRAPM', 'dLEBRON', 'dDARKO', 'CombinedDef',
                'epm', 'Ovr-xRAPM', 'Ovr-LEBRON', 'Ovr-DARKO', 'Multi-Year Ovr',
                'Y1EPM', 'Y2EPM', 'Y3EPM', 'Y4EPM', 'Y5EPM'
            ];

            // --- Data Loading and Processing ---
            async function loadData() {
                try {
                    setLoadingState(true);
                    const response = await fetch(CSV_PATH);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const csvText = await response.text();
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            allPlayers = results.data.map(processRow).filter(p => p.Player);
                            calculateAllPercentiles(allPlayers);
                            renderAll();
                            setLoadingState(false);
                        }
                    });
                } catch (error) {
                    console.error("Error loading or parsing CSV data:", error);
                    setLoadingState(false, true);
                }
            }
            
            function processRow(row) {
                 const numericFields = [
                    'Age', 'oepm', 'depm', 'epm', 'war', 'CombinedOff', 'CombinedDef', 
                    'Y1OEPM', 'Y1DEPM', 'Y1EPM', 'Y1WAR', 'MP65',
                    'Y2OEPM', 'Y2DEPM', 'Y2EPM', 'Y2WAR',
                    'Y3OEPM', 'Y3DEPM', 'Y3EPM', 'Y3WAR',
                    'Y4OEPM', 'Y4DEPM', 'Y4EPM', 'Y4WAR',
                    'Y5OEPM', 'Y5DEPM', 'Y5EPM', 'Y5WAR',
                    'Multi-Year OEPM', 'xORAPM', 'oLEBRON', 'oDARKO', 
                    'Multi-Year DEPM', 'xDRAPM', 'dLEBRON', 'dDARKO', 'Multi-Year Ovr'
                ];
                const currencyFields = ['Y1PV', 'Y2PV', 'Y3PV', 'Y4PV', 'Y5PV', 'Three-Year PV Avg', 'Five-Year PV Avg'];

                const processed = { ...row };
                numericFields.forEach(field => {
                    processed[field] = parseFloat(row[field]) || 0;
                });
                currencyFields.forEach(field => {
                    processed[field] = row[field]; // Keep as formatted string
                });

                // Add calculated fields
                processed['Ovr-xRAPM'] = processed.xORAPM + processed.xDRAPM;
                processed['Ovr-LEBRON'] = processed.oLEBRON + processed.dLEBRON;
                processed['Ovr-DARKO'] = processed.oDARKO + processed.dDARKO;

                return processed;
            }

            function calculateAllPercentiles(players) {
                METRICS_FOR_PERCENTILES.forEach(metric => {
                    const values = players.map(p => p[metric]).sort((a, b) => a - b);
                    const valueMap = new Map();
                    values.forEach((value, index) => {
                        if (!valueMap.has(value)) valueMap.set(value, index);
                    });
                    players.forEach(p => {
                        const rank = valueMap.get(p[metric]);
                        p[`${metric}_pct`] = (rank / (values.length - 1)) * 100;
                    });
                });
            }

            // --- Full Re-render Function ---
            function renderAll() {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredPlayers = searchTerm
                    ? allPlayers.filter(p => p.Player.toLowerCase().includes(searchTerm) || p.Team.toLowerCase().includes(searchTerm))
                    : allPlayers;

                renderMetricsTable(filteredPlayers);
                renderProjectionsTable(filteredPlayers);
                renderTeamChart(allPlayers);
                renderTeamChart5Year(allPlayers);
            }

            // --- Table Rendering ---
            function renderMetricsTable(players) {
                const sorted = sortData(players, metricsSortState.column, metricsSortState.direction);
                metricsTableBody.innerHTML = sorted.map(p => `
                    <tr class="hover:bg-gray-50 cursor-pointer transition" data-player-id="${p.Player}">
                        <td class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">${p.Player}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Team}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Age}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Pos}</td>
                        ${renderMetricCell(p.epm, p.epm_pct)}
                        ${renderMetricCell(p['Ovr-xRAPM'], p['Ovr-xRAPM_pct'])}
                        ${renderMetricCell(p['Ovr-LEBRON'], p['Ovr-LEBRON_pct'])}
                        ${renderMetricCell(p['Ovr-DARKO'], p['Ovr-DARKO_pct'])}
                        ${renderMetricCell(p['Multi-Year Ovr'], p['Multi-Year Ovr_pct'])}
                        ${renderMetricCell(p['Multi-Year OEPM'], p['Multi-Year OEPM_pct'])}
                        ${renderMetricCell(p.xORAPM, p.xORAPM_pct)}
                        ${renderMetricCell(p.oLEBRON, p.oLEBRON_pct)}
                        ${renderMetricCell(p.oDARKO, p.oDARKO_pct)}
                        ${renderMetricCell(p.CombinedOff, p.CombinedOff_pct)}
                        ${renderMetricCell(p['Multi-Year DEPM'], p['Multi-Year DEPM_pct'])}
                        ${renderMetricCell(p.xDRAPM, p.xDRAPM_pct)}
                        ${renderMetricCell(p.dLEBRON, p.dLEBRON_pct)}
                        ${renderMetricCell(p.dDARKO, p.dDARKO_pct)}
                        ${renderMetricCell(p.CombinedDef, p.CombinedDef_pct)}
                    </tr>`).join('');
            }
            
            function renderProjectionsTable(players) {
                 const sorted = sortData(players, projectionsSortState.column, projectionsSortState.direction);
                 projectionsTableBody.innerHTML = sorted.map(p => `
                    <tr class="hover:bg-gray-50 cursor-pointer transition" data-player-id="${p.Player}">
                        <td class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">${p.Player}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Team}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Age}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Pos}</td>
                        ${renderMetricCell(p.Y1EPM, p.Y1EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y1PV}</td>
                        ${renderMetricCell(p.Y2EPM, p.Y2EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y2PV}</td>
                        ${renderMetricCell(p.Y3EPM, p.Y3EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y3PV}</td>
                        ${renderMetricCell(p.Y4EPM, p.Y4EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y4PV}</td>
                        ${renderMetricCell(p.Y5EPM, p.Y5EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y5PV}</td>
                        <td class="px-2 py-2 text-gray-800 font-bold text-center bg-gray-100 whitespace-nowrap">${p['Three-Year PV Avg']}</td>
                        <td class="px-2 py-2 text-gray-800 font-bold text-center bg-gray-100 whitespace-nowrap">${p['Five-Year PV Avg']}</td>
                    </tr>
                `).join('');
            }

            function getPercentileColor(p) {
                if (p === undefined || p === null) return 'background-color: #E0E0E0; color: #333;';
                if (p > 80) return 'background-color: #FDBB30; color: #041E42;'; // Gold
                if (p > 60) return 'background-color: rgba(253, 187, 48, 0.6); color: #041E42;'; // Lighter Gold
                if (p > 40) return 'background-color: #FFFFFF; color: #333; border: 1px solid #E0E0E0;'; // White/Gray for average
                if (p > 20) return 'background-color: rgba(111, 38, 61, 0.5); color: white;'; // Lighter Wine
                return 'background-color: #6F263D; color: white;'; // Wine
            }

            function renderMetricCell(value, percentile) {
                const style = getPercentileColor(percentile);
                return `<td><div class="percentile-cell" style="${style}">
                    <div class="percentile-value">${(value || 0).toFixed(1)}</div>
                    <div class="percentile-rank">(${(percentile || 0).toFixed(0)}%)</div>
                </div></td>`;
            }

            function sortData(players, column, direction) {
                 if (['Y1PV', 'Y2PV', 'Y3PV', 'Y4PV', 'Y5PV', 'Three-Year PV Avg', 'Five-Year PV Avg'].includes(column)) {
                    return [...players].sort((a, b) => {
                        const valA = parseFloat(a[column].replace(/[$,]/g, '')) || 0;
                        const valB = parseFloat(b[column].replace(/[$,]/g, '')) || 0;
                        return direction === 'desc' ? valB - valA : valA - valB;
                    });
                }
                return [...players].sort((a, b) => {
                    const valA = a[column];
                    const valB = b[column];
                    const comparison = valA > valB ? 1 : (valA < valB ? -1 : 0);
                    return direction === 'desc' ? -comparison : comparison;
                });
            }

            // --- Charting ---
            function renderTeamChart(players) {
                const teams = {};
                players.forEach(p => {
                    if (!p.Team || !p.MP65) return;
                    if (!teams[p.Team]) teams[p.Team] = { totalWeightedY1OVR: 0, totalMinutes: 0 };
                    teams[p.Team].totalWeightedY1OVR += p.Y1EPM * p.MP65;
                    teams[p.Team].totalMinutes += p.MP65;
                });
                const teamPerformance = Object.keys(teams).map(team => {
                    const teamStats = teams[team];
                    return { name: team, value: teamStats.totalMinutes > 0 ? teamStats.totalWeightedY1OVR / teamStats.totalMinutes : 0 };
                }).sort((a, b) => b.value - a.value);

                if(teamChartInstance) teamChartInstance.destroy();
                teamChartInstance = new Chart(teamChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: teamPerformance.map(t => t.name),
                        datasets: [{
                            label: 'Minute-Weighted Y1 OVR', data: teamPerformance.map(t => t.value),
                            backgroundColor: '#6F263D', borderColor: '#FDBB30', borderWidth: 1, borderRadius: 5,
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }
            
            function renderTeamChart5Year(players) {
                 const teams = {};
                players.forEach(p => {
                    if (!p.Team || !p.MP65) return;
                    if (!teams[p.Team]) teams[p.Team] = { totalWeighted5YrOVR: 0, totalMinutes: 0 };
                    const avg5YearOVR = (p.Y1EPM + p.Y2EPM + p.Y3EPM + p.Y4EPM + p.Y5EPM) / 5;
                    teams[p.Team].totalWeighted5YrOVR += avg5YearOVR * p.MP65;
                    teams[p.Team].totalMinutes += p.MP65;
                });
                 const teamPerformance = Object.keys(teams).map(team => {
                    const teamStats = teams[team];
                    return { name: team, value: teamStats.totalMinutes > 0 ? teamStats.totalWeighted5YrOVR / teamStats.totalMinutes : 0 };
                }).sort((a, b) => b.value - a.value);

                if(teamChart5YearInstance) teamChart5YearInstance.destroy();
                teamChart5YearInstance = new Chart(teamChart5YearCanvas, {
                    type: 'bar',
                    data: {
                        labels: teamPerformance.map(t => t.name),
                        datasets: [{
                            label: '5-Year Minute-Weighted OVR', data: teamPerformance.map(t => t.value),
                            backgroundColor: '#FDBB30', borderColor: '#6F263D', borderWidth: 1, borderRadius: 5,
                        }]
                    },
                     options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }
            
            // --- Event Listeners & Modal ---
            searchInput.addEventListener('input', renderAll);
            metricsTableHead.addEventListener('click', (e) => handleSort(e, 'metrics'));
            projectionsTableHead.addEventListener('click', (e) => handleSort(e, 'projections'));
            
            document.querySelectorAll('[data-toggle]').forEach(header => {
                header.addEventListener('click', () => {
                    const contentId = header.dataset.toggle;
                    const content = document.getElementById(contentId);
                    const section = header.closest('.bg-white');
                    content.classList.toggle('hidden');
                    section.classList.toggle('section-collapsed');
                });
            });

            document.body.addEventListener('click', (e) => {
                const row = e.target.closest('tr[data-player-id]');
                if (row) {
                    const player = allPlayers.find(p => p.Player === row.dataset.playerId);
                    if(player) showPlayerModal(player);
                }
            });
            closeModal.addEventListener('click', hidePlayerModal);
            playerModal.addEventListener('click', (e) => e.target === playerModal && hidePlayerModal());
            
            function handleSort(e, tableType) {
                const header = e.target.closest('th');
                if (!header?.dataset?.sort) return;
                const sortColumn = header.dataset.sort;
                let sortState = tableType === 'metrics' ? metricsSortState : projectionsSortState;
                sortState.direction = (sortState.column === sortColumn && sortState.direction === 'desc') ? 'asc' : 'desc';
                sortState.column = sortColumn;
                renderAll();
            }

            function showPlayerModal(player) {
                modalPlayerName.textContent = player.Player;
                modalPlayerInfo.textContent = `${player.Pos} | Age: ${player.Age} | Team: ${player.Team}`;
                modalStats.innerHTML = `<h4 class="font-bold text-lg mt-4 mb-2">Projections</h4>
                    ${createStatRow('1-Year OVR / PV', `${player.Y1EPM.toFixed(2)} / ${player.Y1PV}`)}
                    ${createStatRow('3-Year PV Avg', player['Three-Year PV Avg'])}
                    ${createStatRow('5-Year PV Avg', player['Five-Year PV Avg'])}`;
                
                if (playerChartInstance) playerChartInstance.destroy();
                // Placeholder for updated radar chart if needed
                
                playerModal.classList.remove('hidden');
                setTimeout(() => playerModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'), 10);
            }
            function createStatRow(label, value) { return `<div class="flex justify-between border-b pb-1"><span>${label}:</span><span class="font-semibold">${value}</span></div>`;}
            function hidePlayerModal() {
                 playerModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
                 setTimeout(() => playerModal.classList.add('hidden'), 300);
            }
            function setLoadingState(isLoading, isError = false) {
                 const colspan = 20;
                 const loadingHtml = `<tr><td colspan="${colspan}" class="text-center p-8"><div class="text-gray-500">Loading player data...</div></td></tr>`;
                 const errorHtml = `<tr><td colspan="${colspan}" class="text-center p-8"><div class="text-red-500">Failed to load player data.</div></td></tr>`;
                 metricsTableBody.innerHTML = isLoading ? loadingHtml : (isError ? errorHtml : '');
                 projectionsTableBody.innerHTML = isLoading ? loadingHtml : (isError ? errorHtml : '');
            }

            loadData();
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Player Projections Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cavs-wine: #6F263D;
            --cavs-gold: #FDBB30;
            --cavs-navy: #041E42;
            --cavs-light-gray: #E0E0E0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; /* Lighter gray */
            padding-bottom: 120px; /* Space for comparison tray */
        }
        .table-header-sortable {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap;
        }
        .table-header-sortable:hover {
            background-color: var(--cavs-light-gray);
        }
        .sorted-column-header {
            background-color: var(--cavs-gold) !important;
            color: var(--cavs-navy) !important;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            max-width: 90vw;
            width: 700px;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .percentile-cell {
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.8rem;
            line-height: 1.1rem;
            min-width: 70px;
        }
        .percentile-value {
            font-weight: 600;
        }
        .percentile-rank {
            font-size: 0.7rem;
            line-height: 1rem;
            opacity: 0.9;
        }
        .toggle-button svg {
            transition: transform 0.3s ease;
        }
        .section-collapsed .toggle-button svg {
            transform: rotate(-90deg);
        }
        .add-compare-btn.selected {
            background-color: var(--cavs-gold);
            color: var(--cavs-navy);
            font-weight: bold;
        }
        .highlight-col {
            background-color: #fefce8; /* A very light yellow to highlight the composite score column */
            border-left: 2px solid var(--cavs-gold);
            border-right: 2px solid var(--cavs-gold);
        }
        .table-separator {
            width: 2px;
            background-color: var(--cavs-wine);
            padding: 0;
        }
        tr:hover {
            transform: scale(1.01);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 10;
            position: relative;
        }
        .collapsible-content {
            max-height: 1000px; /* Adjust as needed */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.hidden {
            max-height: 0;
        }
        #scrollTopBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99;
            display: none;
        }
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px var(--cavs-gold), 0 0 10px var(--cavs-gold); }
            50% { text-shadow: 0 0 20px var(--cavs-gold), 0 0 30px var(--cavs-gold); }
        }
        .animated-header {
            animation: glow 3s ease-in-out infinite;
        }
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid var(--cavs-light-gray);
            border-bottom-color: var(--cavs-wine);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl md:text-6xl font-bold animated-header" style="color: var(--cavs-wine);">NBA Player Projections</h1>
            <p class="text-lg text-gray-700 mt-2">Interactive data for the upcoming season</p>
        </header>

        <!-- Main Content -->
        <main>
             <!-- Quick Jump Links -->
            <div class="flex justify-center gap-4 mb-8">
                <a href="#metrics-section" class="bg-white text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-xl hover:bg-gray-100 transition-all duration-200">Jump to Metrics</a>
                <a href="#projections-section" class="bg-white text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-xl hover:bg-gray-100 transition-all duration-200">Jump to Projections</a>
            </div>

            <!-- Data Visualization Section -->
            <div class="grid grid-cols-1 gap-8 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-center" style="color: var(--cavs-navy);">Projected Y1 Team Strength</h2>
                    <div class="relative h-96 w-full">
                        <canvas id="teamChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-center" style="color: var(--cavs-navy);">5-Year Team Outlook</h2>
                    <div class="relative h-96 w-full">
                        <canvas id="teamChart5Year"></canvas>
                    </div>
                </div>
            </div>

            <!-- Search & Compare Section -->
            <div class="mb-8 bg-white p-6 rounded-2xl shadow-lg">
                <input type="text" id="searchInput" placeholder="Search by player or team..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--cavs-gold)] transition">
                <div class="mt-4 flex items-center gap-2">
                    <select id="playerSelector" class="w-full p-3 border border-gray-300 rounded-lg">
                        <option>Select a player to add to comparison</option>
                    </select>
                    <button id="addPlayerFromDropdown" class="bg-[var(--cavs-wine)] text-white font-semibold py-3 px-5 rounded-lg hover:opacity-90 transition-all duration-200 shadow hover:shadow-lg">Add</button>
                </div>
            </div>

            <!-- Player Metrics Table -->
            <div id="metrics-section" class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-4 cursor-pointer" data-toggle="metrics-content">
                    <h2 class="text-2xl font-bold">Player Metrics Breakdown</h2>
                    <button class="toggle-button p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="metrics-content" class="collapsible-content overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-xs">
                        <thead id="metricsTableHead" class="bg-gray-100">
                             <tr>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider">Add</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Player">Player</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Team">Team</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Age">Age</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Pos">Pos</th>
                                <!-- Overall -->
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable highlight-col" data-sort="Multi-Year Ovr">Ovr Comp.</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="epm">Ovr-EPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Ovr-xRAPM">Ovr-xRAPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Ovr-LEBRON">Ovr-LEBRON</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Ovr-DARKO">Ovr-DARKO</th>
                                <th class="table-separator"></th>
                                <!-- Offensive -->
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="CombinedOff">Off Comp.</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Multi-Year OEPM">Off-EPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="xORAPM">Off-xRAPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="oLEBRON">Off-LEBRON</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="oDARKO">Off-DARKO</th>
                                <th class="table-separator"></th>
                                <!-- Defensive -->
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="CombinedDef">Def Comp.</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Multi-Year DEPM">Def-EPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="xDRAPM">Def-xRAPM</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="dLEBRON">Def-LEBRON</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="dDARKO">Def-DARKO</th>
                            </tr>
                        </thead>
                        <tbody id="metricsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Player Projections Table -->
            <div id="projections-section" class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4 cursor-pointer" data-toggle="projections-content">
                    <h2 class="text-2xl font-bold">Long-Term Projections</h2>
                    <button class="toggle-button p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="projections-content" class="collapsible-content overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-xs">
                        <thead id="projectionsTableHead" class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider">Add</th>
                               <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Player">Player</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Team">Team</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Age">Age</th>
                                <th class="px-2 py-3 text-left font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Pos">Pos</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y1EPM">Y1 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y1PV">Y1 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y2EPM">Y2 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y2PV">Y2 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y3EPM">Y3 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y3PV">Y3 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y4EPM">Y4 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y4PV">Y4 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y5EPM">Y5 OVR</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable" data-sort="Y5PV">Y5 PV</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable bg-gray-200" data-sort="Three-Year PV Avg">3-Yr PV Avg</th>
                                <th class="px-2 py-3 text-center font-bold text-gray-600 uppercase tracking-wider table-header-sortable bg-gray-200" data-sort="Five-Year PV Avg">5-Yr PV Avg</th>
                            </tr>
                        </thead>
                        <tbody id="projectionsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Player Comparison Tray -->
    <div id="comparisonTray" class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-2xl transform translate-y-full transition-transform duration-300 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h3 class="font-bold text-lg" style="color: var(--cavs-navy);">Player Comparison</h3>
                <div id="comparisonPlayerList" class="flex flex-wrap gap-2 mt-1"></div>
            </div>
            <button id="compareBtn" disabled class="bg-[var(--cavs-gold)] text-[var(--cavs-navy)] font-bold py-2 px-6 rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed">
                Compare (0)
            </button>
        </div>
    </div>

    <!-- Player Comparison Modal -->
    <div id="comparisonModal" class="modal-backdrop hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-300 scale-95 opacity-0 w-full max-w-7xl">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-2xl font-bold" style="color: var(--cavs-navy);">Player Comparison</h3>
                <button id="closeComparisonModal" class="text-gray-400 hover:text-gray-800 transition text-3xl leading-none">&times;</button>
            </div>
            <div id="comparisonContent" class="p-6 max-h-[80vh] overflow-y-auto space-y-8">
                <div>
                    <h4 class="text-xl font-bold text-center mb-4">Offensive Metrics Comparison</h4>
                    <div class="relative h-96">
                        <canvas id="comparisonOffensiveChart"></canvas>
                    </div>
                </div>
                 <div>
                    <h4 class="text-xl font-bold text-center mb-4">Defensive Metrics Comparison</h4>
                    <div class="relative h-96">
                        <canvas id="comparisonDefensiveChart"></canvas>
                    </div>
                </div>
                <div>
                    <h4 class="text-xl font-bold text-center mb-4">5-Year Outlook Comparison (OVR)</h4>
                    <div class="relative h-96">
                         <canvas id="comparisonOutlookChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scroll to Top Button -->
    <button id="scrollTopBtn" class="bg-[var(--cavs-wine)] text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-[var(--cavs-navy)] transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
    </button>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CSV_PATH = 'Composite Projections.csv';
            
            // --- DOM Elements ---
            const searchInput = document.getElementById('searchInput');
            const teamChartCanvas = document.getElementById('teamChart');
            const teamChart5YearCanvas = document.getElementById('teamChart5Year');
            const metricsTableBody = document.getElementById('metricsTableBody');
            const projectionsTableBody = document.getElementById('projectionsTableBody');
            const metricsTableHead = document.getElementById('metricsTableHead');
            const projectionsTableHead = document.getElementById('projectionsTableHead');
            const scrollTopBtn = document.getElementById('scrollTopBtn');
            
            // --- Comparison Elements ---
            const playerSelector = document.getElementById('playerSelector');
            const addPlayerFromDropdown = document.getElementById('addPlayerFromDropdown');
            const comparisonTray = document.getElementById('comparisonTray');
            const comparisonPlayerList = document.getElementById('comparisonPlayerList');
            const compareBtn = document.getElementById('compareBtn');
            const comparisonModal = document.getElementById('comparisonModal');
            const closeComparisonModal = document.getElementById('closeComparisonModal');
            const comparisonOffensiveChartCanvas = document.getElementById('comparisonOffensiveChart');
            const comparisonDefensiveChartCanvas = document.getElementById('comparisonDefensiveChart');
            const comparisonOutlookChartCanvas = document.getElementById('comparisonOutlookChart');

            // --- State ---
            let allPlayers = [];
            let comparisonList = new Map(); // Use a Map for easier lookups and ordering
            let metricsSortState = { column: 'Multi-Year Ovr', direction: 'desc' };
            let projectionsSortState = { column: 'Y1EPM', direction: 'desc' };
            let teamChartInstance = null;
            let teamChart5YearInstance = null;
            let comparisonOffensiveChart = null;
            let comparisonDefensiveChart = null;
            let comparisonOutlookChart = null;

             const METRICS_FOR_PERCENTILES = [
                'Multi-Year OEPM', 'xORAPM', 'oLEBRON', 'oDARKO', 'CombinedOff',
                'Multi-Year DEPM', 'xDRAPM', 'dLEBRON', 'dDARKO', 'CombinedDef',
                'epm', 'Ovr-xRAPM', 'Ovr-LEBRON', 'Ovr-DARKO', 'Multi-Year Ovr',
                'Y1EPM', 'Y2EPM', 'Y3EPM', 'Y4EPM', 'Y5EPM'
            ];

            // --- Data Loading and Processing ---
            async function loadData() {
                try {
                    setLoadingState(true);
                    const response = await fetch(CSV_PATH);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const csvText = await response.text();
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            metricsTableBody.innerHTML = '';
                            projectionsTableBody.innerHTML = '';
                            allPlayers = results.data.map(processRow).filter(p => p.Player).sort((a,b) => a.Player.localeCompare(b.Player));
                            calculateAllPercentiles(allPlayers);
                            populateCompareDropdown();
                            renderAll();
                        }
                    });
                } catch (error) {
                    console.error("Error loading or parsing CSV data:", error);
                    setLoadingState(false, true);
                }
            }
            
            function processRow(row) {
                 const numericFields = [
                    'Age', 'oepm', 'depm', 'epm', 'war', 'CombinedOff', 'CombinedDef', 
                    'Y1OEPM', 'Y1DEPM', 'Y1EPM', 'Y1WAR', 'MP65',
                    'Y2OEPM', 'Y2DEPM', 'Y2EPM', 'Y2WAR',
                    'Y3OEPM', 'Y3DEPM', 'Y3EPM', 'Y3WAR',
                    'Y4OEPM', 'Y4DEPM', 'Y4EPM', 'Y4WAR',
                    'Y5OEPM', 'Y5DEPM', 'Y5EPM', 'Y5WAR',
                    'Multi-Year OEPM', 'xORAPM', 'oLEBRON', 'oDARKO', 
                    'Multi-Year DEPM', 'xDRAPM', 'dLEBRON', 'dDARKO', 'Multi-Year Ovr'
                ];
                const currencyFields = ['Y1PV', 'Y2PV', 'Y3PV', 'Y4PV', 'Y5PV', 'Three-Year PV Avg', 'Five-Year PV Avg'];

                const processed = { ...row };
                numericFields.forEach(field => {
                    processed[field] = parseFloat(row[field]) || 0;
                });
                currencyFields.forEach(field => {
                    processed[field] = row[field]; // Keep as formatted string
                });

                // Add calculated fields
                processed['Ovr-xRAPM'] = processed.xORAPM + processed.xDRAPM;
                processed['Ovr-LEBRON'] = processed.oLEBRON + processed.dLEBRON;
                processed['Ovr-DARKO'] = processed.oDARKO + processed.dDARKO;

                return processed;
            }

            function calculateAllPercentiles(players) {
                METRICS_FOR_PERCENTILES.forEach(metric => {
                    const values = players.map(p => p[metric]).sort((a, b) => a - b);
                    const valueMap = new Map();
                    values.forEach((value, index) => {
                        if (!valueMap.has(value)) valueMap.set(value, index);
                    });
                    players.forEach(p => {
                        const rank = valueMap.get(p[metric]);
                        p[`${metric}_pct`] = (rank / (values.length - 1)) * 100;
                    });
                });
            }

            // --- Full Re-render Function ---
            function renderAll() {
                setLoadingState(false);
                const searchTerm = searchInput.value.toLowerCase();
                const filteredPlayers = searchTerm
                    ? allPlayers.filter(p => p.Player.toLowerCase().includes(searchTerm) || p.Team.toLowerCase().includes(searchTerm))
                    : allPlayers;

                renderMetricsTable(filteredPlayers);
                renderProjectionsTable(filteredPlayers);
                renderTeamChart(allPlayers);
                renderTeamChart5Year(allPlayers);
                updateCompareButtons();
                updateActiveSortColumn();
            }

            // --- Table Rendering ---
            function renderMetricsTable(players) {
                const sorted = sortData(players, metricsSortState.column, metricsSortState.direction);
                metricsTableBody.innerHTML = sorted.map(p => `
                    <tr class="hover:bg-gray-50 transition" data-player-id="${p.Player}">
                        <td class="px-2 py-2 text-center align-middle">
                            <button data-compare-id="${p.Player}" class="add-compare-btn text-xl w-6 h-6 rounded-full flex items-center justify-center border-2 border-gray-300 hover:border-[var(--cavs-gold)] transition">+</button>
                        </td>
                        <td class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">${p.Player}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Team}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Age}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Pos}</td>
                        ${renderMetricCell(p['Multi-Year Ovr'], p['Multi-Year Ovr_pct'], 'highlight-col')}
                        ${renderMetricCell(p.epm, p.epm_pct)}
                        ${renderMetricCell(p['Ovr-xRAPM'], p['Ovr-xRAPM_pct'])}
                        ${renderMetricCell(p['Ovr-LEBRON'], p['Ovr-LEBRON_pct'])}
                        ${renderMetricCell(p['Ovr-DARKO'], p['Ovr-DARKO_pct'])}
                        <td class="table-separator"></td>
                        ${renderMetricCell(p.CombinedOff, p.CombinedOff_pct)}
                        ${renderMetricCell(p['Multi-Year OEPM'], p['Multi-Year OEPM_pct'])}
                        ${renderMetricCell(p.xORAPM, p.xORAPM_pct)}
                        ${renderMetricCell(p.oLEBRON, p.oLEBRON_pct)}
                        ${renderMetricCell(p.oDARKO, p.oDARKO_pct)}
                        <td class="table-separator"></td>
                        ${renderMetricCell(p.CombinedDef, p.CombinedDef_pct)}
                        ${renderMetricCell(p['Multi-Year DEPM'], p['Multi-Year DEPM_pct'])}
                        ${renderMetricCell(p.xDRAPM, p.xDRAPM_pct)}
                        ${renderMetricCell(p.dLEBRON, p.dLEBRON_pct)}
                        ${renderMetricCell(p.dDARKO, p.dDARKO_pct)}
                    </tr>`).join('');
            }
            
            function renderProjectionsTable(players) {
                 const sorted = sortData(players, projectionsSortState.column, projectionsSortState.direction);
                 projectionsTableBody.innerHTML = sorted.map(p => `
                    <tr class="hover:bg-gray-50 transition" data-player-id="${p.Player}">
                        <td class="px-2 py-2 text-center align-middle">
                            <button data-compare-id="${p.Player}" class="add-compare-btn text-xl w-6 h-6 rounded-full flex items-center justify-center border-2 border-gray-300 hover:border-[var(--cavs-gold)] transition">+</button>
                        </td>
                        <td class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">${p.Player}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Team}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Age}</td>
                        <td class="px-2 py-2 text-gray-500">${p.Pos}</td>
                        ${renderMetricCell(p.Y1EPM, p.Y1EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y1PV}</td>
                        ${renderMetricCell(p.Y2EPM, p.Y2EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y2PV}</td>
                        ${renderMetricCell(p.Y3EPM, p.Y3EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y3PV}</td>
                        ${renderMetricCell(p.Y4EPM, p.Y4EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y4PV}</td>
                        ${renderMetricCell(p.Y5EPM, p.Y5EPM_pct)}
                        <td class="px-2 py-2 text-gray-700 font-semibold text-center whitespace-nowrap">${p.Y5PV}</td>
                        <td class="px-2 py-2 text-gray-800 font-bold text-center bg-gray-100 whitespace-nowrap">${p['Three-Year PV Avg']}</td>
                        <td class="px-2 py-2 text-gray-800 font-bold text-center bg-gray-100 whitespace-nowrap">${p['Five-Year PV Avg']}</td>
                    </tr>
                `).join('');
            }

            function getPercentileColor(p) {
                if (p === undefined || p === null) return 'background-color: #f3f4f6; color: #374151;';
                if (p >= 90) return 'background-color: #1a9641; color: white;';
                if (p >= 75) return 'background-color: #66c2a5; color: black;';
                if (p >= 50) return 'background-color: #abdda4; color: black;';
                if (p >= 25) return 'background-color: #ffffbf; color: black;';
                if (p >= 10) return 'background-color: #fdae61; color: black;';
                return 'background-color: #d7191c; color: white;';
            }

            function renderMetricCell(value, percentile, additionalClasses = '') {
                const style = getPercentileColor(percentile);
                return `<td class="${additionalClasses}"><div class="percentile-cell" style="${style}">
                    <div class="percentile-value">${(value || 0).toFixed(1)}</div>
                    <div class="percentile-rank">(${(percentile || 0).toFixed(0)}%)</div>
                </div></td>`;
            }

            function sortData(players, column, direction) {
                 if (['Y1PV', 'Y2PV', 'Y3PV', 'Y4PV', 'Y5PV', 'Three-Year PV Avg', 'Five-Year PV Avg'].includes(column)) {
                    return [...players].sort((a, b) => {
                        const valA = parseFloat(a[column].replace(/[$,]/g, '')) || 0;
                        const valB = parseFloat(b[column].replace(/[$,]/g, '')) || 0;
                        return direction === 'desc' ? valB - valA : valA - valB;
                    });
                }
                return [...players].sort((a, b) => {
                    const valA = a[column];
                    const valB = b[column];
                    const comparison = valA > valB ? 1 : (valA < valB ? -1 : 0);
                    return direction === 'desc' ? -comparison : comparison;
                });
            }

            // --- Charting ---
            function renderTeamChart(players) {
                const teams = {};
                players.forEach(p => {
                    if (!p.Team || !p.MP65) return;
                    if (!teams[p.Team]) teams[p.Team] = { totalWeightedY1OVR: 0, totalMinutes: 0 };
                    teams[p.Team].totalWeightedY1OVR += p.Y1EPM * p.MP65;
                    teams[p.Team].totalMinutes += p.MP65;
                });
                const teamPerformance = Object.keys(teams).map(team => {
                    const teamStats = teams[team];
                    return { name: team, value: teamStats.totalMinutes > 0 ? teamStats.totalWeightedY1OVR / teamStats.totalMinutes : 0 };
                }).sort((a, b) => b.value - a.value);

                if(teamChartInstance) teamChartInstance.destroy();
                teamChartInstance = new Chart(teamChartCanvas, {
                    type: 'bar', data: {
                        labels: teamPerformance.map(t => t.name),
                        datasets: [{ label: 'Minute-Weighted Y1 OVR', data: teamPerformance.map(t => t.value), backgroundColor: '#6F263D', borderColor: '#FDBB30', borderWidth: 1, borderRadius: 5, }]
                    }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { title: { display: true, text: 'Projected OVR', font: { weight: 'bold' } } }, x: { title: { display: true, text: 'Team', font: { weight: 'bold' } }, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45, font: { size: 10, weight: 'bold' } } } } }
                });
            }
            
            function renderTeamChart5Year(players) {
                 const teams = {};
                players.forEach(p => {
                    if (!p.Team || !p.MP65) return;
                    if (!teams[p.Team]) teams[p.Team] = { totalWeighted5YrOVR: 0, totalMinutes: 0 };
                    const avg5YearOVR = (p.Y1EPM + p.Y2EPM + p.Y3EPM + p.Y4EPM + p.Y5EPM) / 5;
                    teams[p.Team].totalWeighted5YrOVR += avg5YearOVR * p.MP65;
                    teams[p.Team].totalMinutes += p.MP65;
                });
                 const teamPerformance = Object.keys(teams).map(team => {
                    const teamStats = teams[team];
                    return { name: team, value: teamStats.totalMinutes > 0 ? teamStats.totalWeighted5YrOVR / teamStats.totalMinutes : 0 };
                }).sort((a, b) => b.value - a.value);

                if(teamChart5YearInstance) teamChart5YearInstance.destroy();
                teamChart5YearInstance = new Chart(teamChart5YearCanvas, {
                    type: 'bar', data: {
                        labels: teamPerformance.map(t => t.name),
                        datasets: [{ label: '5-Year Minute-Weighted OVR', data: teamPerformance.map(t => t.value), backgroundColor: '#FDBB30', borderColor: '#6F263D', borderWidth: 1, borderRadius: 5, }]
                    }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { title: { display: true, text: 'Projected 5-Year Avg. OVR', font: { weight: 'bold' } } }, x: { title: { display: true, text: 'Team', font: { weight: 'bold' } }, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45, font: { size: 10, weight: 'bold' } } } } }
                });
            }

            // --- Player Comparison Logic ---
            function populateCompareDropdown() {
                playerSelector.innerHTML = '<option value="">Select a player to compare...</option>';
                allPlayers.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.Player;
                    option.textContent = p.Player;
                    playerSelector.appendChild(option);
                });
            }

            function toggleComparePlayer(playerId) {
                const player = allPlayers.find(p => p.Player === playerId);
                if (!player) return;

                if (comparisonList.has(playerId)) {
                    comparisonList.delete(playerId);
                } else {
                    comparisonList.set(playerId, player);
                }
                renderComparisonTray();
                updateCompareButtons();
            }

            function renderComparisonTray() {
                const players = Array.from(comparisonList.values());
                if (players.length > 0) {
                    comparisonPlayerList.innerHTML = players.map(p => `
                        <div class="flex items-center gap-2 bg-gray-100 rounded-full pr-2">
                            <span class="pl-3 text-sm font-semibold">${p.Player}</span>
                            <button data-remove-compare="${p.Player}" class="text-red-500 hover:text-red-700 font-bold">&times;</button>
                        </div>
                    `).join('');
                    comparisonTray.classList.remove('translate-y-full');
                } else {
                    comparisonTray.classList.add('translate-y-full');
                }
                compareBtn.textContent = `Compare (${players.length})`;
                compareBtn.disabled = players.length < 2;
            }

            function updateCompareButtons() {
                document.querySelectorAll('.add-compare-btn').forEach(btn => {
                    const playerId = btn.dataset.compareId;
                    if (comparisonList.has(playerId)) {
                        btn.classList.add('selected');
                        btn.textContent = 'âœ“';
                    } else {
                        btn.classList.remove('selected');
                        btn.textContent = '+';
                    }
                });
            }
            
            function showComparisonModal() {
                const players = Array.from(comparisonList.values());
                const colors = ['#6F263D', '#FDBB30', '#041E42', '#9E9E9E', '#FFC107'];

                // Offensive Metrics Bar Chart
                const offLabels = ['Off Comp.', 'Off-EPM', 'Off-xRAPM', 'Off-LEBRON', 'Off-DARKO'];
                const offDatasets = players.map((p, i) => ({
                    label: p.Player,
                    data: [p.CombinedOff, p['Multi-Year OEPM'], p.xORAPM, p.oLEBRON, p.oDARKO],
                    backgroundColor: colors[i % colors.length],
                }));
                if(comparisonOffensiveChart) comparisonOffensiveChart.destroy();
                comparisonOffensiveChart = new Chart(comparisonOffensiveChartCanvas, {
                    type: 'bar',
                    data: { labels: offLabels, datasets: offDatasets },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
                });

                 // Defensive Metrics Bar Chart
                const defLabels = ['Def Comp.', 'Def-EPM', 'Def-xRAPM', 'Def-LEBRON', 'Def-DARKO'];
                const defDatasets = players.map((p, i) => ({
                    label: p.Player,
                    data: [p.CombinedDef, p['Multi-Year DEPM'], p.xDRAPM, p.dLEBRON, p.dDARKO],
                    backgroundColor: colors[i % colors.length],
                }));
                if(comparisonDefensiveChart) comparisonDefensiveChart.destroy();
                comparisonDefensiveChart = new Chart(comparisonDefensiveChartCanvas, {
                    type: 'bar',
                    data: { labels: defLabels, datasets: defDatasets },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
                });

                // Outlook Line Chart
                const outlookLabels = ['Y1', 'Y2', 'Y3', 'Y4', 'Y5'];
                const outlookDatasets = players.map((p, i) => ({
                    label: p.Player,
                    data: [p.Y1EPM, p.Y2EPM, p.Y3EPM, p.Y4EPM, p.Y5EPM],
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '33', // semi-transparent fill
                    fill: false,
                    tension: 0.1
                }));
                 if(comparisonOutlookChart) comparisonOutlookChart.destroy();
                comparisonOutlookChart = new Chart(comparisonOutlookChartCanvas, {
                    type: 'line',
                    data: { labels: outlookLabels, datasets: outlookDatasets },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { title: { display: true, text: 'Projected OVR' } } } }
                });


                comparisonModal.classList.remove('hidden');
                setTimeout(() => comparisonModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'), 10);
            }
            
            function hideComparisonModal() {
                comparisonModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
                setTimeout(() => comparisonModal.classList.add('hidden'), 300);
            }

            function updateActiveSortColumn() {
                document.querySelectorAll('.sorted-column-header').forEach(th => th.classList.remove('sorted-column-header'));
                const metricsHeader = metricsTableHead.querySelector(`[data-sort="${metricsSortState.column}"]`);
                if(metricsHeader) metricsHeader.classList.add('sorted-column-header');
                const projectionsHeader = projectionsTableHead.querySelector(`[data-sort="${projectionsSortState.column}"]`);
                if(projectionsHeader) projectionsHeader.classList.add('sorted-column-header');
            }
            
            // --- Event Listeners & Modals ---
            searchInput.addEventListener('input', renderAll);
            addPlayerFromDropdown.addEventListener('click', () => {
                if (playerSelector.value) {
                    toggleComparePlayer(playerSelector.value);
                    playerSelector.value = "";
                }
            });

            const sortHandler = (e, tableType) => {
                const header = e.target.closest('th');
                if (!header?.dataset?.sort) return;
                const sortColumn = header.dataset.sort;
                let sortState = tableType === 'metrics' ? metricsSortState : projectionsSortState;
                sortState.direction = (sortState.column === sortColumn && sortState.direction === 'desc') ? 'asc' : 'desc';
                sortState.column = sortColumn;
                renderAll();
            };

            metricsTableHead.addEventListener('click', (e) => sortHandler(e, 'metrics'));
            projectionsTableHead.addEventListener('click', (e) => sortHandler(e, 'projections'));
            
            document.querySelectorAll('[data-toggle]').forEach(header => {
                header.addEventListener('click', (e) => {
                    const content = document.getElementById(header.dataset.toggle);
                    const section = header.closest('.bg-white');
                    section.classList.toggle('section-collapsed');
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            });


            document.body.addEventListener('click', (e) => {
                const compareBtnEl = e.target.closest('.add-compare-btn');
                const removeCompareBtn = e.target.closest('[data-remove-compare]');

                if (compareBtnEl) {
                    toggleComparePlayer(compareBtnEl.dataset.compareId);
                } else if(removeCompareBtn) {
                     toggleComparePlayer(removeCompareBtn.dataset.removeCompare);
                }
            });
            
            compareBtn.addEventListener('click', showComparisonModal);
            closeComparisonModal.addEventListener('click', hideComparisonModal);

            window.addEventListener('scroll', () => {
                if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                    scrollTopBtn.style.display = "block";
                } else {
                    scrollTopBtn.style.display = "none";
                }
            });

            scrollTopBtn.addEventListener('click', () => {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });
            
            function setLoadingState(isLoading, isError = false) {
                 const colspan = 22;
                 const loadingHtml = `<tr><td colspan="${colspan}" class="text-center p-8"><div class="loader mx-auto"></div></td></tr>`;
                 const errorHtml = `<tr><td colspan="${colspan}" class="text-center p-8"><div class="text-red-500 font-semibold">Failed to load player data. Ensure 'Composite Projections.csv' is in the same folder.</div></td></tr>`;
                 if (isLoading) {
                     metricsTableBody.innerHTML = loadingHtml;
                     projectionsTableBody.innerHTML = loadingHtml;
                 } else if (isError) {
                     metricsTableBody.innerHTML = errorHtml;
                     projectionsTableBody.innerHTML = errorHtml;
                 }
            }

            loadData();
        });
    </script>
</body>
</html>

